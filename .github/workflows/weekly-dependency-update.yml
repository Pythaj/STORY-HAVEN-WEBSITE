name: Weekly Dependency Update

on:
  schedule:
    # Run every Sunday at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-dependencies:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --legacy-peer-deps

    - name: Create backup
      run: npm run backup-deps

    - name: Update dependencies safely
      run: npm run update-deps-safe

    - name: Run tests after update
      run: npm run test-after-update

    - name: Health check
      run: npm run health-check

    - name: Generate update report
      run: |
        echo "## ðŸ“¦ Weekly Dependency Update Report" > update-report.md
        echo "" >> update-report.md
        echo "### Update Date: $(date)" >> update-report.md
        echo "" >> update-report.md
        if [ -f update-report.json ]; then
          echo "Changes made:" >> update-report.md
          cat update-report.json | jq -r '.changes[]? | "- \(.name): \(.from) â†’ \(.to) (\(.change))"' >> update-report.md || echo "No changes detected" >> update-report.md
        fi
        if [ -f health-report.json ]; then
          echo "" >> update-report.md
          echo "Health Status:" >> update-report.md
          cat health-report.json | jq -r '.checks | "- Node: \(if .nodeHealth then "âœ…" else "âŒ" end)" - Build: \(if .buildHealth then "âœ…" else "âŒ" end)" - Dependencies: \(if .dependenciesHealth then "âœ…" else "âŒ" end)"' >> update-report.md || echo "Health check completed" >> update-report.md
        fi

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          ðŸ”„ Weekly dependency update

          - Updated dependencies to latest compatible versions
          - Fixed security vulnerabilities
          - Tested build and functionality
          - Generated health report
        title: 'ðŸ”„ Weekly Dependency Update'
        body: |
          ## ðŸ“¦ Automated Dependency Update

          This PR contains the latest dependency updates and security fixes.

          ### Changes Made:
          - Updated dependencies to latest compatible versions
          - Applied security patches
          - Maintained backward compatibility
          - All tests passing

          ### Testing:
          - âœ… Build successful
          - âœ… TypeScript compilation
          - âœ… Linting passed
          - âœ… No breaking changes

          ### Files Updated:
          - package.json
          - package-lock.json
          - Generated reports

          **Please review and merge if everything looks good!**
        branch: dependency-updates/weekly
        delete-branch: true
        labels: |
          dependencies
          automated
          weekly-update
