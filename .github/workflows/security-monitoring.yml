name: Security Monitoring

on:
  schedule:
    # Run daily at 4 AM UTC
    - cron: '0 4 * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches: [ main ]
    paths:
      - 'package.json'
      - 'package-lock.json'

jobs:
  security-audit:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --legacy-peer-deps

    - name: Run security audit
      run: npm audit --audit-level high

    - name: Check for vulnerabilities
      id: audit
      run: |
        audit_output=$(npm audit --audit-level high --json)
        echo "audit_result<<EOF" >> $GITHUB_OUTPUT
        echo "$audit_output" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        # Check if there are high or critical vulnerabilities
        vulnerabilities=$(echo "$audit_output" | jq '.vulnerabilities | to_entries | map(select(.value.severity == "high" or .value.severity == "critical")) | length')
        echo "vulnerability_count=$vulnerabilities" >> $GITHUB_OUTPUT

    - name: Fix vulnerabilities automatically
      if: steps.audit.outputs.vulnerability_count > 0
      run: |
        npm audit fix --legacy-peer-deps
        npm run update-deps-safe

    - name: Run tests after security fixes
      if: steps.audit.outputs.vulnerability_count > 0
      run: npm run test-after-update

    - name: Create security report
      run: |
        echo "## ðŸ”’ Security Audit Report" > security-report.md
        echo "" >> security-report.md
        echo "### Date: $(date)" >> security-report.md
        echo "" >> security-report.md

        if [ "${{ steps.audit.outputs.vulnerability_count }}" -gt 0 ]; then
          echo "### ðŸš¨ Vulnerabilities Found and Fixed" >> security-report.md
          echo "High/Critical vulnerabilities were detected and automatically fixed." >> security-report.md
          echo "" >> security-report.md
          echo "Please review the changes and test thoroughly." >> security-report.md
        else
          echo "### âœ… No Security Issues" >> security-report.md
          echo "All dependencies are secure with no known vulnerabilities." >> security-report.md
        fi

        echo "" >> security-report.md
        echo "### Dependencies Checked:" >> security-report.md
        echo "- **Total Dependencies:** $(cat package.json | jq '.dependencies | length')" >> security-report.md
        echo "- **Dev Dependencies:** $(cat package.json | jq '.devDependencies | length')" >> security-report.md
        echo "- **Audit Level:** High" >> security-report.md

    - name: Create issue for manual review
      if: steps.audit.outputs.vulnerability_count > 0
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('security-report.md', 'utf8');

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸ”’ Security Update Required',
            body: report,
            labels: ['security', 'automated', 'needs-review']
          });

    - name: Comment on PR if security fixes were applied
      if: steps.audit.outputs.vulnerability_count > 0
      uses: actions/github-script@v7
      with:
        script: |
          const { exec } = require('child_process');
          const util = require('util');
          const execAsync = util.promisify(exec);

          try {
            // Check if there are uncommitted changes
            const { stdout: status } = await execAsync('git status --porcelain');
            if (status.trim()) {
              // Create a PR if there are changes
              await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ”’ Security Update - Automated Fix',
                body: 'Security vulnerabilities were detected and automatically fixed. Please review the changes.',
                head: 'security-fixes/auto',
                base: 'main',
                labels: ['security', 'automated', 'needs-review']
              });
            }
          } catch (error) {
            console.log('Could not create PR:', error.message);
          }
